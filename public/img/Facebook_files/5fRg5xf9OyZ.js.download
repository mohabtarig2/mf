if (self.CavalryLogger) { CavalryLogger.start_js_script(document.currentScript); }/*FB_PKG_DELIM*/

__d("LSUpdateBackupsTable",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSFlushDataTrace.bs"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1];c.n;var d=[],e=[],f;return c.seq([function(e){return c.seq([function(d){return function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsUpdateBackupsTableStoredProcedure]Beginning execution."),a[5]!==f?c.sp(b("LSAppendDataTraceAddon"),a[5],[0,1467],[0,2],f,f):c.resolve()},function(e){return a[0]?c.seq([function(a){return c.islc(c.ftr(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,[0,80])}),0,c.i64.to_float([0,1])).next().then(function(a,b){var e=a.done;a=a.value;return e?(e=[f,f,f,f,f,[0,1]],d[1]=e[0],d[2]=e[1],d[3]=e[2],d[4]=e[3],d[5]=e[4],d[6]=e[5],e):(b=a.item,d[12]=b.backupTenancy,c.i64.neq(d[12],f)?d[11]=d[12]:d[11]=[0,1],e=[b.backupId,b.deviceId,b.mailboxRootKeyBlob,b.ocmfClientStateBlob,b.encryptionVersion,d[11]],d[1]=e[0],d[2]=e[1],d[3]=e[2],d[4]=e[3],d[5]=e[4],d[6]=e[5],e)})},function(e){return d[8]=!1,d[9]=c.i64.of_int32(a[3].length),c.i64.gt(d[9],[0,0])?c.loopAsync(d[9],function(e){return d[11]=e,c.seq([function(e){return c.ntop("Array",b("LSArrayGetObjectAt"),a[3],d[11]).then(function(a){return a=a,d[12]=a[0],d[13]=a[1],a})},function(a){return d[14]=d[12].get("device_id"),d[12],d[8]=d[8]||c.i64.eq(d[2],d[14])}])}):c.resolve()},function(a){return d[8]?c.resolve():(function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsUpdateBackupsTableStoredProcedure]Client device id not in the list of device ids associated with the backupClearing backup client state table"),c.fe(c.db.table(168).fetch(),function(a){return a["delete"]()}))},function(e){return d[10]=c.i64.of_int32(a[1].length),c.i64.gt(d[10],[0,0])?c.seq([function(e){return c.ntop("Array",b("LSArrayGetObjectAt"),a[1],[0,0]).then(function(a){return a=a,d[11]=a[0],d[12]=a[1],a})},function(a){return d[13]=d[11].get("backup_id"),d[11],d[14]=d[11].get("backup_tenancy"),d[11],c.fe(c.ftr(c.db.table(172).fetch([[[[0,1]]]]),function(a){return c.i64.eq(a.pk,[0,1])&&c.i64.lt(a.authorityLevel,[0,80])}),function(a){return a["delete"]()})},function(a){return c.db.table(172).add({pk:[0,1],backupId:d[13],authorityLevel:[0,80],backupTenancy:d[14]})}]):c.seq([function(a){return c.fe(c.ftr(c.db.table(172).fetch([[[[0,1]]]]),function(a){return c.i64.eq(a.pk,[0,1])&&c.i64.lt(a.authorityLevel,[0,80])}),function(a){return a["delete"]()})},function(a){return c.db.table(172).add({pk:[0,1],authorityLevel:[0,80]})}])}]):c.seq([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsUpdateBackupsTableStoredProcedure]Fetch backup task did not succeed."),c.fe(c.db.table(172).fetch(),function(a){return a["delete"]()})},function(a){return c.fe(c.ftr(c.db.table(172).fetch([[[[0,1]]]]),function(a){return c.i64.eq(a.pk,[0,1])&&c.i64.lt(a.authorityLevel,[0,80])}),function(a){return a["delete"]()})},function(a){return c.db.table(172).add({pk:[0,1],backupId:[-1,4294967295],authorityLevel:[0,80]})}])},function(a){return c.fe(c.ftr(c.db.table(184).fetch(),function(a){return!0}),function(a){return a["delete"]()})},function(e){return d[0]=c.i64.of_int32(a[2].length),c.i64.gt(d[0],[0,0])?c.loopAsync(d[0],function(e){return d[1]=e,c.seq([function(e){return c.ntop("Array",b("LSArrayGetObjectAt"),a[2],d[1]).then(function(a){return a=a,d[2]=a[0],d[3]=a[1],a})},function(a){return d[4]=d[2].get("virtual_devices"),d[2],d[4]?d[5]=!1:d[5]=!0,d[5]?c.resolve():(d[6]=c.i64.of_int32(d[4].length),c.i64.gt(d[6],[0,0])?c.loopAsync(d[6],function(a){return d[7]=a,c.seq([function(a){return c.ntop("Array",b("LSArrayGetObjectAt"),d[4],d[7]).then(function(a){return a=a,d[8]=a[0],d[9]=a[1],a})},function(a){return d[10]=d[8].get("virtual_device_id"),d[8],d[11]=d[8].get("virtual_device_type"),d[8],d[12]=d[2].get("backup_id"),d[2],c.ct(c.ftr(c.db.table(184).fetch(),function(a){return c.i64.eq(a.backupId,d[12])&&c.blobs.eq(a.virtualDeviceId,d[10])})).then(function(a){return d[13]=a})},function(a){return c.i64.eq(d[13],[0,0])?(d[14]=d[2].get("backup_id"),d[2],c.db.table(184).add({pk:void 0,backupId:d[14],virtualDeviceId:d[10],virtualDeviceType:d[11]})):c.resolve()}])}):c.resolve())}])}):c.resolve()},function(d){return a[5]!==f?c.nop(b("LSFlushDataTrace.bs"),a[5]):c.resolve()},function(a){return function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsUpdateBackupsTableStoredProcedure]Finishing execution.")}])},function(a){return c.resolve(e)}])}e.exports=a}),null);